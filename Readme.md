# User Auth JWT Python API

This project(user-auth-jwt-python-api) is developed for software engineer who use JWT(JSON Web Token) as a authentication server. 
It enables developer to build web-server with authentication easily.
This server is mainly build with python(fastapi), mysql in database. 

## Requirements
### For All
- `OpenSSL`

### Run Local (for Ubuntu)

- TBD

### Using Docker

- Docker Engine

### Using Docker Compose

- Docker Engine
- Docker Compose

## Preparation
### Create Public and Private Key

```
$ ./gen_key.sh
```
Running the scripts above will generate private/public key inside `./key` directory. 
Will not be generated if already exists.

### Login GitHub on Docker

- Token generated from github is required
- docker login with github token is required in order to use the image

[Personal access tokens](https://github.com/settings/tokens)
Click `generate new token` 
Fill in the reason why you need token.
Check `read:packages` in the `write:packages`.
Copy the generated token and login with the command below.
```
$ docker login -u <GitHub username> -p <generated token> 
docker.pkg.github.com
```
## Environment Variables

- `PRIVATE_KEY_PATH`
    - Specify directory where private key is stored
    - default: "./key/private-key.pem"
- `PUBLIC_KEY_PATH`
    - Specify directory where public key is stored
    - default "./key/public-key.pem"
- `DB_USER`
    - Specify user name of the DB
    - default "root"
- `DB_PASSWORD`
    - Specify password for the DB
    - default "root"
- `DB_HOST`
    - Specify destination for the DB
    - ex. localhost
    - default "mysql"
- `DB_USER`
    - Specify DB name
    - default "user-auth"

## Installation
### Build from Source (for Ubuntu)

- Install pipenv
- Install Pipfile contents by pipenv

Install `pipenv` to management version of python

```
$ pip install pipenv
```
Change python version to 3.8
```
$ pipenv --python 3.8
```
Install library which is required by running the command described below.

```
$ pipenv install -r requirements.txt
```

### Build Docker Image from Source

Following command is required in order to build this image.

```
$ docker build -t user-auth-jwt-python-api .
```

### Using Docker Image

Using Docker image or the `docker-compose.yml` that comes with this repository requires to pull the Docker image. In addition, `docker login` is required in advance with the authentication information of GitHub.


```
$ docker pull docker.pkg.github.com/oreotabetai/user-auth-jwt-python-api/user-auth-jwt-python-api:main
```

## Run Apps
### Build from Source

Uses by pipenv is described below. 
Server will run in port 3000 in `localhost`.
Setting environment is required before running the server. 

```
$ pipenv run uvicorn server:app --reload --host 0.0.0.0 --port 3000
```

### Build Docker Image from Source

Building docker image from the source is described below.
Setting environment is required before running the server.(ex. `-e DB_USER=root` )

```
$ docker run -d -p 3000 docker.pkg.github.com/oreotabetai/user-auth-jwt-python-api/user-auth-jwt-python-api:main
```

### Using Docker Image

Using docker image is described below.
Setting environment is required before running the server.(ex. `-e DB_USER=root` )
Server will run in port 3000 in `localhost`.
```
$ docker run -d -p 3000 user-auth-jwt-python-api
```

### Using Docker Compose

Running the following command will automatically build MySQL. Data is stored in Docker Volume and can be also save to the host's storage area by setting `docker-compose.yml` appropriately. 
Setting `docker-compose.dev.yml` can also build without pulling the image. In this way, run `docker-compose -f docker-compose.dev.yml build`.

Server will run in port 3000 in `localhost`.
```
$ docker-compose up -d 
```

## Usage
### End Points

|Method|Path|Function|
|:-:|:-|:-|
|`GET`|`/`|For testing, returns plain String|
|`GET`|`/docs`|You can see API document for Swagger UI. We recommend accessing from a Offers login function.
|`POST`|`/login`| Send appropriate userID(`Id`) and password by JSON, you are returned JSON Web Token.|
|`POST`|`/register`|Offer registration function. Send User ID(`id`) and password(`password`) by JSON, regist your information|


See `http://<app_host>:<app_port>/docs` for a detailed specification of the API. You can also try the API here.

### Verification of JWT

Implement the JWT authorization mechanism in each application. Validity of JWT can be checked by using public key generated by Preparation. 
See below for an implementation of the JWT authorization mechanism.

- Ruby: https://github.com/jwt/ruby-jwt
- NodeJS: https://github.com/auth0/node-jsonwebtoken
- Go: https://github.com/dgrijalva/jwt-go
- Python: https://pyjwt.readthedocs.io/en/stable/

There are many implementations in other languages and environments.

You can also try and verify the validity of JWT from the following URL. To perform verification, please use the public key generated by Preparation.

- JWT.io: https://jwt.io/

## For Contributers
### Requirements
- `Python ~= 3.8`
- `Pipenv`

### Preparation for Development Environment

```
$ pipenv install --dev
```

### Directory Structure

```
.
├── Dockerfile
├── LICENSE
├── Pipfile
├── Pipfile.lock
├── docker-compose.dev.yml          # for developers
├── docker-compose.yml              # for users
├── gen_key.sh                      # for key generation
├── server.py                       # main source code
├── sql                             # for DB initialization 
│   ├── 01.create-user-table.sql
│   └── 02.insert-initial-users.sql
├── src                             # app source code
│   ├── auth.py
│   ├── db.py
│   ├── model
│   │   ├── auth.py
│   │   └── user.py
│   └── user.py
└── test_server.py                  # E2E Test
```

### Run Apps

```
$ pipenv run uvicorn server:app --reload --host 0.0.0.0 --port 3000
```

### Testing

```
$ pipenv run pytest
```